#!/bin/bash

# Health check script for Zilliqa 2.0 services

# Function to check if a service is running
check_service() {
    local service=$1
    if ! systemctl is-active --quiet $service; then
        echo "Service $service is not running"
        return 1
    fi
    return 0
}

# Function to check if a Docker container is running
check_container() {
    local container=$1
    if ! docker ps --format '{{.Names}}' | grep -q "^$container$"; then
        echo "Container $container is not running"
        return 1
    fi
    return 0
}

# Check Zilliqa node
check_service zilliqa
check_container zilliqa

# Check Otterscan if enabled
if [[ "{{ node_roles }}" == *"otterscan"* ]]; then
    check_service otterscan
    check_container otterscan
fi

# Check Spout if enabled
if [[ "{{ spout_enabled }}" == "true" ]]; then
    check_service spout
    check_container spout
fi

# Check Stats Dashboard if enabled
if [[ "{{ node_roles }}" == *"stats"* ]]; then
    check_service stats-dashboard
    check_container stats-dashboard
fi

# Check Stats Agent if enabled
if [[ "{{ node_roles }}" == *"stats"* ]]; then
    check_service stats-agent
    check_container stats-agent
fi

# Check monitoring services if enabled
if [[ "{{ zq2_metrics_enabled }}" == "true" ]]; then
    check_service node_exporter
    check_service process_exporter
fi

# Check healthcheck service
check_service healthcheck 