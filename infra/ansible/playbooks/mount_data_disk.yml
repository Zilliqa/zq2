---
- name: Mount data disk
  hosts: all
  become: true
  tags:
    - install
    - all
  
  tasks:
  
    - name: Check if data disk device exists
      ansible.builtin.stat:
        path: /dev/disk/by-id/google-data
      register: data_disk_device
      failed_when: false
      changed_when: false

    - name: Get real device path for data disk
      ansible.builtin.command: readlink -f /dev/disk/by-id/google-data
      register: data_disk_path
      when: data_disk_device.stat.exists
      changed_when: false
      failed_when: false

    - name: Check if data disk is already formatted
      ansible.builtin.command: blkid {{ data_disk_path.stdout }}
      register: disk_formatted
      when: data_disk_device.stat.exists
      changed_when: false
      failed_when: false

    - name: Format data disk with ext4
      ansible.builtin.filesystem:
        fstype: ext4
        dev: "{{ data_disk_path.stdout }}"
        opts: -L data
      when:
        - data_disk_device.stat.exists
        - disk_formatted.rc != 0

    - name: Ensure /data directory exists
      ansible.builtin.file:
        path: /data
        state: directory
        mode: '0755'
      when: data_disk_device.stat.exists

    - name: Get UUID of data disk
      ansible.builtin.command: blkid -s UUID -o value {{ data_disk_path.stdout }}
      register: data_disk_uuid
      when: data_disk_device.stat.exists
      changed_when: false
      failed_when: false

    - name: Mount data disk to /data
      ansible.builtin.mount:
        path: /data
        src: "UUID={{ data_disk_uuid.stdout }}"
        fstype: ext4
        opts: defaults,nofail
        state: mounted
      when:
        - data_disk_device.stat.exists
        - data_disk_uuid.stdout is defined
        - data_disk_uuid.stdout != ""

    - name: Set ownership of /data directory
      ansible.builtin.file:
        path: /data
        owner: root
        group: root
        mode: '0755'
      when: data_disk_device.stat.exists

    - name: Display message if data disk not found
      ansible.builtin.debug:
        msg: "Data disk not found on this node, skipping mount configuration"
      when: not data_disk_device.stat.exists

    - name: Ensure Google snapshots directory exists
      ansible.builtin.file:
        path: /etc/google/snapshots
        state: directory
        mode: '0755'
        owner: root
        group: root
      when: data_disk_device.stat.exists

    - name: Create pre-snapshot script
      ansible.builtin.copy:
        dest: /etc/google/snapshots/pre.sh
        content: |
          #!/bin/bash
          sudo fsfreeze -f /data
        mode: '0755'
        owner: root
        group: root
      when: data_disk_device.stat.exists

    - name: Create post-snapshot script
      ansible.builtin.copy:
        dest: /etc/google/snapshots/post.sh
        content: |
          #!/bin/bash
          sudo fsfreeze -u /data
        mode: '0755'
        owner: root
        group: root
      when: data_disk_device.stat.exists

    - name: Ensure /etc/default directory exists
      ansible.builtin.file:
        path: /etc/default
        state: directory
        mode: '0755'
        owner: root
        group: root
      when: data_disk_device.stat.exists

    - name: Configure application consistent snapshots
      ansible.builtin.blockinfile:
        path: /etc/default/instance_configs.cfg
        create: yes
        mode: '0644'
        owner: root
        group: root
        marker: "# {mark} ANSIBLE MANAGED BLOCK - Snapshots Configuration"
        insertafter: EOF
        block: |
          [Snapshots]
          enabled = {{ gcp_snapshot_enabled | default('true') }}
          timeout_in_seconds = {{ gcp_snapshot_timeout | default('300') }}
      when: data_disk_device.stat.exists
      register: snapshot_config

    - name: Restart Google Guest Agent to apply snapshot settings
      ansible.builtin.systemd:
        name: google-guest-agent.service
        state: restarted
      when:
        - data_disk_device.stat.exists
        - snapshot_config.changed

